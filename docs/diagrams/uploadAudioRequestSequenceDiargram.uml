@startuml


Client -> AuthInterceptor : Open connnection request \n HEADERS: auth:<user:pass>
AuthInterceptor -> AuthzInterceptor : Open connnection request \n HEADERS: auth:<user:pass> \n SecurityContextHolder
AuthzInterceptor -> EarsService : Open connection request
EarsService -> EarsService: get principals
Client -> EarsService : Send metadata. \n TotalFileSize: X bytes \n RecordStartTimestamp: Y ns

EarsService -> AudioService : getUploader(username)

EarsService <-- AudioService : uploader instance


alt #Gold Выгрузка данных
Client -> EarsService : send batch

EarsService -> EarsService: uploader.writeBatch()
end

Client -> EarsService : Connection clone request
Client <-- EarsService : Upload end response

@enduml

@startuml
EarsService -> AudioService : getUploader(username, Metadata)



AudioService -> UserRepository : getUserByUsername(username)

AudioService <-- UserRepository : User

AudioService -> AudioService : Проверка бизнес правил

AudioService -> AudioRecordInfoRepository : create AudioRecordInfo
AudioService <-- AudioRecordInfoRepository : UUID

AudioService -> AudioService : instance FileUploader

AudioService -> FileStorage : getUploader(String uuid)
AudioService <-- FileStorage : uploaderInstance

EarsService <-- AudioService : FileUploader instance reference

EarsService -> "FileUploader instance" : writeBatch (метод асинхронный)

EarsService -> "FileUploader instance" : close

EarsService -> AudioService : fileUploadedNotify(file_uuid)

AudioService -> AudioRecordInfoRepository : update info

alt transmissionError
EarsService -> "FileUploader instance" : close
"FileUploader instance" -> "FileUploader instance" : close writing thread \n and throw exception
EarsService <-- "FileUploader instance" : exception
EarsService -> AudioService : fileUploadFailNotify(file_uuid)
AudioService -> FileStorage : deleteFile(file_uuid)
AudioService -> AudioRecordInfoRepository : update info
end

@enduml
     ┌───────────┐                   ┌────────────┐                         ┌──────────────┐           ┌─────────────────────────┐          ┌─────────────────────┐
     │EarsService│                   │AudioService│                         │UserRepository│           │AudioRecordInfoRepository│          │FileUploader instance│
     └─────┬─────┘                   └──────┬─────┘                         └───────┬──────┘           └────────────┬────────────┘          └──────────┬──────────┘
           │getUploader(username, Metadata) │                                       │                               │                                  │           
           │───────────────────────────────>│                                       │                               │                                  │           
           │                                │                                       │                               │                                  │           
           │                                │     getUserByUsername(username)       │                               │                                  │           
           │                                │──────────────────────────────────────>│                               │                                  │           
           │                                │                                       │                               │                                  │           
           │                                │                 User                  │                               │                                  │           
           │                                │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                               │                                  │           
           │                                │                                       │                               │                                  │           
           │                                │────┐                                  │                               │                                  │           
           │                                │    │ Проверка бизнес правил           │                               │                                  │           
           │                                │<───┘                                  │                               │                                  │           
           │                                │                                       │                               │                                  │           
           │                                │                        create AudioRecordInfo                         │                                  │           
           │                                │──────────────────────────────────────────────────────────────────────>│                                  │           
           │                                │                                       │                               │                                  │           
           │                                │                                 UUID  │                               │                                  │           
           │                                │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │                                  │           
           │                                │                                       │                               │                                  │           
           │                                │────┐                                  │                               │                                  │           
           │                                │    │ create new instance FileUploader │                               │                                  │           
           │                                │<───┘                                  │                               │                                  │           
           │                                │                                       │                               │                                  │           
           │FileUploader instance reference │                                       │                               │                                  │           
           │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                       │                               │                                  │           
           │                                │                                       │                               │                                  │           
           │                                │                     writeBatch (метод асинхронный)                    │                                  │           
           │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│           
           │                                │                                       │                               │                                  │           
           │                                │                                 close │                               │                                  │           
           │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│           
           │                                │                                       │                               │                                  │           
           │                                │                                       │   fileUploadedNotify          │                                  │           
           │                                │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│           
           │                                │                                       │                               │                                  │           
           │                                │                             update info                               │                                  │           
           │                                │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>│                                  │           
     ┌─────┴─────┐                   ┌──────┴─────┐                         ┌───────┴──────┐           ┌────────────┴────────────┐          ┌──────────┴──────────┐
     │EarsService│                   │AudioService│                         │UserRepository│           │AudioRecordInfoRepository│          │FileUploader instance│
     └───────────┘                   └────────────┘                         └──────────────┘           └─────────────────────────┘          └─────────────────────┘
